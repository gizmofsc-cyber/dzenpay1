const { PrismaClient } = require('@prisma/client')
const { execSync } = require('child_process')

const prisma = new PrismaClient()

async function fixAndMigrate() {
  try {
    console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π...')
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    try {
      await prisma.$connect()
      console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')
    } catch (connectError) {
      console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏')
      console.log('‚ÑπÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ API endpoint')
      return
    }
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏—è—Ö
    try {
      const result = await prisma.$executeRaw`
        DELETE FROM "_prisma_migrations" 
        WHERE finished_at IS NULL
      `
      console.log('‚úÖ –ó–∞–ø–∏—Å–∏ –æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏—è—Ö —É–¥–∞–ª–µ–Ω—ã')
    } catch (error) {
      if (error.code === 'P2021') {
        console.log('‚ÑπÔ∏è –¢–∞–±–ª–∏—Ü–∞ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–¥–∏–º –µ—ë –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏')
      } else {
        console.log('‚ÑπÔ∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):', error.message)
      }
    }
    
    await prisma.$disconnect()
    
    console.log('üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π...')
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    try {
      execSync('npx prisma migrate deploy', { 
        stdio: 'inherit',
        env: { ...process.env },
        timeout: 20000 // 20 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
      })
      console.log('‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!')
    } catch (migrateError) {
      // –ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–±–æ—Ä–∫—É
      const errorMessage = migrateError.message || migrateError.toString()
      if (errorMessage.includes('timed out') || 
          errorMessage.includes('P1002') ||
          errorMessage.includes('advisory lock')) {
        console.log('‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π (–≤–æ–∑–º–æ–∂–Ω–æ –ë–î –∑–∞–Ω—è—Ç–∞)')
        console.log('‚ÑπÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑: /api/fix-migrations')
        console.log('‚ÑπÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–±–æ—Ä–∫—É...')
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–±–æ—Ä–∫—É
      } else {
        console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π:', errorMessage)
        console.log('‚ÑπÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–±–æ—Ä–∫—É, –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ')
      }
    }
    
  } catch (error) {
    console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –º–∏–≥—Ä–∞—Ü–∏–π:', error.message)
    console.log('‚ÑπÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–±–æ—Ä–∫—É –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π')
    console.log('‚ÑπÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è')
    // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–±–æ—Ä–∫—É
  }
}

fixAndMigrate()

