# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ P3009

## –ü—Ä–æ–±–ª–µ–º–∞

–û—à–∏–±–∫–∞: `P3009 - migrate found failed migrations in the target database`

–≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —É–ø–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π, –∏ Prisma –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏.

## –†–µ—à–µ–Ω–∏–µ 1: –ß–µ—Ä–µ–∑ API endpoint (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–í—ã–∑–æ–≤–∏—Ç–µ endpoint –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π:

```bash
curl -X POST https://dzenpay.vercel.app/api/fix-migrations \
  -H "Authorization: Bearer init-secret-key-change-in-production"
```

–ò–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```
https://dzenpay.vercel.app/api/fix-migrations
```

## –†–µ—à–µ–Ω–∏–µ 2: –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Neon –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
-- –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –Ω–µ—É–¥–∞—á–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
DELETE FROM "_prisma_migrations" 
WHERE migration_name = '20251006093314_init' 
AND finished_at IS NULL;

-- –ü–æ–º–µ—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—É—é
INSERT INTO "_prisma_migrations" (migration_name, started_at, finished_at, applied_steps_count)
VALUES ('20251006093314_init', NOW(), NOW(), 1)
ON CONFLICT (migration_name) DO NOTHING;
```

## –†–µ—à–µ–Ω–∏–µ 3: –ß–µ—Ä–µ–∑ Prisma CLI

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
# –ü–æ–º–µ—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—É—é
npx prisma migrate resolve --applied 20251006093314_init

# –ò–ª–∏ –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ—Ç–∫–∞—Ç–∞–Ω–Ω—É—é –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∑–∞–Ω–æ–≤–æ
npx prisma migrate resolve --rolled-back 20251006093314_init
npx prisma migrate deploy
```

## –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π –Ω–∞ Vercel (–∏–ª–∏ –æ–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
2. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ
3. –í—ã–∑–æ–≤–∏—Ç–µ endpoint –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
   ```
   POST https://dzenpay.vercel.app/api/init-database
   ```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–í `package.json` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ –¥–µ–ø–ª–æ–µ:

```json
"vercel-build": "prisma generate && (prisma migrate deploy || prisma migrate resolve --applied 20251006093314_init) && next build"
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–ø–∞–¥–µ—Ç, –æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—Ç–∏—Ç—Å—è –∫–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω–∞—è.

